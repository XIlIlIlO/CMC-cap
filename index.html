<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Top Market Cap × 1H Turnover</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: black;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }
    body {
      transform: scale(0.68);
      transform-origin: top left;
      width: 133.33%;
      height: 133.33%;
      padding: 40px;
    }
    h1 { font-size: 26px; font-weight: bold; margin: 0 0 8px 0; }
    #time { margin-bottom: 16px; font-size: 16px; color: #cccccc; }
    #countdown { margin-left: 16px; color: #888; }
    .hint { color:#888; font-size: 14px; margin-bottom: 8px; }
  </style>
</head>
<body>
  <h1>■ 시가총액 TOP × 1시간 거래대금 (5분마다 갱신) ■</h1>
  <div class="hint">메인 막대: 시가총액 / 보조 막대: <b>1시간치 거래대금</b> / 색상: 1시간 시가↔종가 (↑ green / ↓ red)</div>

  <div id="time">
    UTC 시간 로딩 중... <span id="countdown">다음 갱신까지 300s</span>
  </div>

  <svg id="chart" width="1200" height="1500"></svg>

  <script>
    const API_URL = "https://binance-flask-app-production.up.railway.app/top_marketcap_enriched";

    // 레이아웃
    const rowHeight   = 50;       // 한 행 전체 높이
    const capBarH     = 26;       // 시총 메인 막대 높이
    const capBarStart = 240;      // 메인 막대 시작 X
    const capBarMaxW  = 600;      // 메인 막대 최대 길이

    const volBarH     = 8;        // 거래대금 보조 막대 높이
    const volBarY     = capBarH + 6;
    const volBarMaxW  = 550;      // 거래대금 보조 막대 최대 길이

    const svg = d3.select("#chart");

    let previousDataMap = new Map();
    let secondsToNextUpdate = 300; // 5분

    function numCompact(n) {
      if (n == null || isNaN(n)) return "—";
      const abs = Math.abs(n);
      if (abs >= 1e12) return (n / 1e12).toFixed(2) + "T";
      if (abs >= 1e9 ) return (n / 1e9 ).toFixed(2) + "B";
      if (abs >= 1e6 ) return (n / 1e6 ).toFixed(2) + "M";
      if (abs >= 1e3 ) return (n / 1e3 ).toFixed(2) + "K";
      return n.toFixed(0);
    }

    function updateTimeLabel() {
      const now = new Date();
      const y = now.getUTCFullYear();
      const m = String(now.getUTCMonth() + 1).padStart(2, '0');
      const d = String(now.getUTCDate()).padStart(2, '0');
      const h = String(now.getUTCHours()).padStart(2, '0');
      const mm = String(now.getUTCMinutes()).padStart(2, '0');
      document.getElementById("time").childNodes[0].textContent = `${y}-${m}-${d} ${h}:${mm} UTC`;
    }

    function startCountdown() {
      setInterval(() => {
        secondsToNextUpdate--;
        if (secondsToNextUpdate <= 0) secondsToNextUpdate = 300;
        document.getElementById("countdown").textContent = `다음 갱신까지 ${secondsToNextUpdate}s`;
      }, 1000);
    }

    async function fetchData() {
      const res = await fetch(API_URL, { cache: "no-store" });
      const j = await res.json();
      return j.data || [];
    }

    function colorOf(d) {
      // 서버가 color_1h(green/red)를 넣어준다. 예외 시 안전색상 지정.
      if (d.color_1h === "green") return "#00ff88";
      if (d.color_1h === "red")   return "#ff3366";
      // fallback: 종가-시가 비교
      if (d.close_1h != null && d.open_1h != null) {
        return d.close_1h >= d.open_1h ? "#00ff88" : "#ff3366";
      }
      return "#00ff88";
    }

    async function updateChart() {
      updateTimeLabel();
      secondsToNextUpdate = 300;

      let data = await fetchData();
      if (!data || data.length === 0) return;

      // 시총 내림차순 정렬 보장
      data.sort((a, b) => (b.market_cap_usd || 0) - (a.market_cap_usd || 0));

      const maxCap = d3.max(data, d => Math.max(0, d.market_cap_usd || 0));
      const maxTurnover = d3.max(data, d => Math.max(0, d.volume_usdt_1h || 0));

      svg.attr("height", data.length * rowHeight + 60);

      const rows = svg.selectAll("g.row")
        .data(data, d => d.futures_symbol || d.symbol);

      const enter = rows.enter()
        .append("g")
        .attr("class", "row")
        .attr("transform", (d, i) => `translate(40, ${i * rowHeight})`);

      // 순위
      enter.append("text")
        .attr("class", "rank")
        .attr("x", 0)
        .attr("y", capBarH / 2)
        .attr("dy", ".35em")
        .attr("fill", "#ccc")
        .style("font-size", "14px");

      // 심볼/이름
      enter.append("text")
        .attr("class", "label")
        .attr("x", 40)
        .attr("y", capBarH / 2)
        .attr("dy", ".35em")
        .attr("fill", "white")
        .style("font-weight", "bold");

      // 시총 메인 막대
      enter.append("rect")
        .attr("class", "bar-cap")
        .attr("x", capBarStart)
        .attr("y", 0)
        .attr("height", capBarH)
        .attr("width", 0)
        .attr("fill", "#00ff88");

      // 시총 값 라벨
      enter.append("text")
        .attr("class", "value-cap")
        .attr("x", capBarStart + 10)
        .attr("y", capBarH / 2)
        .attr("dy", ".35em")
        .attr("fill", "white");

      // 거래대금 보조 막대 (흰색)
      enter.append("rect")
        .attr("class", "bar-vol")
        .attr("x", capBarStart)
        .attr("y", volBarY)
        .attr("height", volBarH)
        .attr("width", 0)
        .attr("fill", "#ffffff")
        .attr("opacity", 1);

      // 거래대금 라벨
      enter.append("text")
        .attr("class", "value-vol")
        .attr("x", capBarStart + 10)
        .attr("y", volBarY + volBarH / 2)
        .attr("dy", ".35em")
        .attr("fill", "#cccccc")
        .style("font-size", "12px");

      const merged = enter.merge(rows);

      // 위치 갱신
      merged.transition().duration(800)
        .attr("transform", (d, i) => `translate(40, ${i * rowHeight})`);

      // 각 요소 업데이트
      merged.each(function(d, i) {
        const g = d3.select(this);

        const capVal = Math.max(0, d.market_cap_usd || 0);
        const capW = maxCap > 0 ? (capVal / maxCap) * capBarMaxW : 0;

        const volVal = Math.max(0, d.volume_usdt_1h || 0);
        const volW = maxTurnover > 0 ? (volVal / maxTurnover) * volBarMaxW : 0;

        g.select("text.rank").text(String(d.rank).padStart(2, " "));

        g.select("text.label")
          .text(` ${d.symbol} — ${d.name}`);

        g.select("rect.bar-cap")
          .transition().duration(800)
          .attr("width", capW)
          .attr("fill", colorOf(d));

        g.select("text.value-cap")
          .text(`$${numCompact(capVal)}`)
          .transition().duration(800)
          .attr("x", capBarStart + Math.max(10, capW + 10))
          .attr("text-anchor", "start");

        g.select("rect.bar-vol")
          .transition().duration(800)
          .attr("width", volW);

        g.select("text.value-vol")
          .text(`${numCompact(volVal)} USDT`)
          .transition().duration(800)
          .attr("x", capBarStart + Math.max(10, volW + 10))
          .attr("text-anchor", "start");
      });

      rows.exit().remove();

      // 랭크 추적(선택)
      previousDataMap.clear();
      data.forEach((d, i) => previousDataMap.set(d.symbol, { ...d, rank: i+1 }));
    }

    updateChart();
    setInterval(updateChart, 5 * 60 * 1000); // 5분
    startCountdown();
  </script>
</body>
</html>
