<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Top 30 Market Cap + 1H Turnover</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      background-color: black; color: white;
      font-family: sans-serif;
      overflow: hidden;
      width: 100vw; height: 100vh;
    }
    body {
      transform: scale(0.68);
      transform-origin: top left;
      width: 133.33%; height: 133.33%;
      padding: 40px;
    }
    #time { margin-bottom: 20px; font-size: 16px; color: #ccc; }
    #countdown { margin-left: 12px; color: #888; }
  </style>
</head>
<body>
  <h1 style="font-size:26px;font-weight:bold;">
    â–  SUPERHERO ì‹œê°€ì´ì•¡ TOP30 + 1ì‹œê°„ ê±°ë˜ëŒ€ê¸ˆ â– 
  </h1>
  <div id="time">
    UTC ì‹œê°„ ë¡œë”© ì¤‘...
    <span style="color:#aaa;">(1ì‹œê°„ ê±°ë˜ëŒ€ê¸ˆ, 5ë¶„ë§ˆë‹¤ ê°±ì‹ )</span>
    <span id="countdown">ë‹¤ìŒ ê°±ì‹ ê¹Œì§€ 300s</span>
  </div>
  <svg id="chart" width="1100" height="1600"></svg>

  <script>
    const API_URL = "https://binance-flask-app-production.up.railway.app/top_marketcap_enriched";

    const rowHeight = 50;
    const barHeight = 26;
    const labelY    = barHeight / 2;
    const barStartX = 250;

    // ë©”ì¸(ì‹œì´) ë§‰ëŒ€ ìµœëŒ€ ê¸¸ì´, ê±°ë˜ëŒ€ê¸ˆ(1H) ë³´ì¡° ë§‰ëŒ€ ìµœëŒ€ ê¸¸ì´
    const mcBarMaxW   = 650;
    const turnBarMaxW = 550;

    const svg = d3.select("#chart");
    let secondsToNextUpdate = 300; // 5ë¶„ ì£¼ê¸°
    let previousDataMap = new Map();

    function formatCompact(n) {
      if (n == null || isNaN(n)) return "N/A";
      if (n >= 1e12) return (n/1e12).toFixed(2) + "T";
      if (n >= 1e9)  return (n/1e9 ).toFixed(2) + "B";
      if (n >= 1e6)  return (n/1e6 ).toFixed(2) + "M";
      if (n >= 1e3)  return (n/1e3 ).toFixed(2) + "K";
      return n.toFixed(0);
    }

    function updateTimeLabel() {
      const now = new Date();
      const y = now.getUTCFullYear();
      const m = String(now.getUTCMonth() + 1).padStart(2, '0');
      const d = String(now.getUTCDate()).padStart(2, '0');
      const h = String(now.getUTCHours()).padStart(2, '0');
      const mm = String(now.getUTCMinutes()).padStart(2, '0');
      document.getElementById("time").childNodes[0].textContent =
        `${y}-${m}-${d} ${h}:${mm} UTC `;
    }

    function startCountdown() {
      setInterval(() => {
        secondsToNextUpdate--;
        if (secondsToNextUpdate <= 0) secondsToNextUpdate = 300;
        document.getElementById("countdown").textContent =
          `ë‹¤ìŒ ê°±ì‹ ê¹Œì§€ ${secondsToNextUpdate}s`;
      }, 1000);
    }

    async function fetchData() {
      const res = await fetch(API_URL);
      const payload = await res.json();
      return (payload && payload.data) ? payload.data : [];
    }

    function barColor(color1h) {
      if (color1h === "green") return "#00ff88";
      if (color1h === "red")   return "#ff3366";
      return "#777777"; // ì„ ë¬¼ ë¯¸ìƒì¥/ë°ì´í„° ì—†ìŒ ë“±
    }

    async function updateChart() {
      updateTimeLabel();
      secondsToNextUpdate = 300;

      const data = await fetchData();
      if (!data || data.length === 0) return;

      // ì‹œì´ ë‚´ë¦¼ì°¨ìˆœ ë³´ì¥
      data.sort((a, b) => (b.market_cap_usd || 0) - (a.market_cap_usd || 0));

      const maxMC   = d3.max(data, d => Math.max(0, d.market_cap_usd || 0));
      const maxTurn = d3.max(data, d => Math.max(0, d.volume_usdt_1h || 0));

      svg.attr("height", data.length * rowHeight + 60);

      // ğŸ”‘ keyë¥¼ ì„ ë¬¼ ì‹¬ë³¼ë¡œ ê³ ì • (fallback: SYMBOL+USDT)
      const keyFn = d => d.futures_symbol || (d.symbol ? d.symbol + "USDT" : d.symbol);
      const group = svg.selectAll("g.row").data(data, keyFn);

      const enter = group.enter()
        .append("g")
        .attr("class", "row")
        .attr("transform", (d, i) => `translate(50, ${i * rowHeight})`);

      // ë¼ë²¨: ì„ ë¬¼ ì‹¬ë³¼ë§Œ
      enter.append("text")
        .attr("class", "label")
        .attr("x", 50)
        .attr("y", labelY)
        .attr("dy", ".35em")
        .attr("text-anchor", "start")
        .attr("fill", "white")
        .style("font-weight", "bold")
        .style("cursor", "pointer")
        .style("opacity", 0)
        .on("click", function (evt, d) {
          const fsym = keyFn(d);
          if (fsym) window.open(`https://www.binance.com/en/futures/${fsym}`, "_blank");
        });

      // ë©”ì¸ ë§‰ëŒ€(ì‹œì´)
      enter.append("rect")
        .attr("class", "bar-mc")
        .attr("x", barStartX)
        .attr("y", 0)
        .attr("height", barHeight)
        .attr("width", 0)
        .attr("fill", "#777");

      // ì‹œì´ ê°’ ë¼ë²¨
      enter.append("text")
        .attr("class", "value-mc")
        .attr("x", barStartX + 10)
        .attr("y", labelY)
        .attr("dy", ".35em")
        .attr("fill", "white")
        .style("opacity", 0);

      // ê±°ë˜ëŒ€ê¸ˆ ë³´ì¡° ë§‰ëŒ€(1H, í°ìƒ‰)
      enter.append("rect")
        .attr("class", "bar-turn")
        .attr("x", barStartX)
        .attr("y", barHeight + 6)
        .attr("height", 8)
        .attr("width", 0)
        .attr("fill", "#ffffff")
        .attr("opacity", 1);

      // ê±°ë˜ëŒ€ê¸ˆ ë¼ë²¨
      enter.append("text")
        .attr("class", "value-turn")
        .attr("x", barStartX + 10)
        .attr("y", barHeight + 6 + 4)
        .attr("dy", ".35em")
        .attr("fill", "#cccccc")
        .style("font-size", "12px")
        .style("opacity", 0);

      const merged = enter.merge(group);

      // ìœ„ì¹˜ ê°±ì‹ 
      merged.transition().duration(800)
        .attr("transform", (d, i) => `translate(50, ${i * rowHeight})`);

      // ìš”ì†Œ ê°±ì‹ 
      merged.each(function(d) {
        const g = d3.select(this);

        const fsym = keyFn(d); // ë¼ë²¨ì— ì“¸ ì„ ë¬¼ ì‹¬ë³¼
        const mc   = Math.max(0, d.market_cap_usd || 0);
        const mcW  = maxMC > 0 ? (mc / maxMC) * mcBarMaxW : 0;

        const turn  = Math.max(0, d.volume_usdt_1h || 0);
        const turnW = maxTurn > 0 ? (turn / maxTurn) * turnBarMaxW : 0;

        // ë¼ë²¨: ì„ ë¬¼ ì‹¬ë³¼ë§Œ
        g.select("text.label")
          .text(fsym || "")
          .transition().duration(800)
          .style("opacity", 1);

        // ë©”ì¸(ì‹œì´) ë§‰ëŒ€
        g.select("rect.bar-mc")
          .transition().duration(1000)
          .attr("width", mcW)
          .attr("fill", barColor(d.color_1h));

        // ì‹œì´ ê°’
        g.select("text.value-mc")
          .transition().duration(1000)
          .style("opacity", 1)
          .tween("text", function() {
            const prev = previousDataMap.get(fsym);
            const start = prev ? (prev.market_cap_usd || 0) : 0;
            const interp = d3.interpolateNumber(start, mc);
            return function(t) { this.textContent = `$${formatCompact(interp(t))}`; };
          })
          .attr("x", barStartX + Math.max(10, mcW + 10))
          .attr("text-anchor", "start");

        // ê±°ë˜ëŒ€ê¸ˆ ë§‰ëŒ€
        g.select("rect.bar-turn")
          .transition().duration(1000)
          .attr("width", turnW);

        // ê±°ë˜ëŒ€ê¸ˆ ë¼ë²¨
        g.select("text.value-turn")
          .text(`${formatCompact(turn)} USDT`)
          .transition().duration(800)
          .style("opacity", 1)
          .attr("x", barStartX + Math.max(10, turnW + 10))
          .attr("text-anchor", "start");
      });

      // í‡´ì¥
      group.exit().remove();

      // ì´ì „ ê°’ ê¸°ë¡(ì‹œì´ë§Œ ë³´ê´€)
      previousDataMap.clear();
      data.forEach(d => {
        const fsym = keyFn(d);
        previousDataMap.set(fsym, { market_cap_usd: d.market_cap_usd });
      });
    }

    updateChart();
    setInterval(updateChart, 300 * 1000); // 5ë¶„
    startCountdown();
  </script>
</body>
</html>
